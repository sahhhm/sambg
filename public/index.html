<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>bg</title>
  <!--<link rel="stylesheet" type="text/css" href="css/style.css" />-->
</head>
<body>
  <div id="lobby">
    <button id="create_button"> create room </button>
    <div id="list_of_rooms"></div>
  </div>
  
  <div id="game_area" width='2000px' height='2000px'></div>
  
</body>
</html>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="game.js"></script>

<script src="space.js"></script>

<script src="drawer.js"></script>
<script src="dice.js"></script>
<script src="player.js"></script>
<script src="board.js"></script>
<script src="bg.js"></script>
<script src="turnhistory.js"></script>


<script language="javascript" type="text/javascript">
  var socket = io.connect(window.location.hostname);
  var selectedRoom = -1;
  var me = {};  
  var bbgame = null; //global game
   
   socket.on('room refresh', function(data){
     var list = $("#list_of_rooms").html('').append('<ul></ul>').find('ul');
     for (var i =0; i < data.length; i++) {
       list.append('<li id="room-' + data[i] +'"><div id="room">' + data[i] + '</div></li>');
     }
     
     if (selectedRoom != -1) {
       $('#create_button').attr('disabled', true);
       $("#room-"+selectedRoom).append('<div id="room-leave-'+selectedRoom+'"> - leave</div>'); 
     } else {
       $('#create_button').attr('disabled', false);
       $("#list_of_rooms li").each(function(index) {
         $(this).append('<div id="room-join-'+selectedRoom+'"> - join</div>');
       });
     }

   });
   
   socket.on('room chosen', function(data){
     selectedRoom = data.room;
   });
   
   socket.on('load game', function(data){
     $('#lobby').hide();
     initGame(null, null, data);
     newGame();
	 bggame.board.drawer.drawBoard();
	 bggame.board.drawer.drawNakedBoard();
   });
   
   socket.on('dice', function(data) {
     console.log("got dice event");
     bggame.board.roll( { die1: data.die1, die2 : data.die2 } );
     bggame.board.update( { forPlayer : me.num } );
     bggame.board.waitingForNextTurn = false;
   });
   
   socket.on('game over', function(data) {
     console.log("game over");
	  $('#game-over-area').html( 'Game over... Player ' + data.winnerNum + ' won with ' + data.points + ' points!' +
                                 '<button id="do-play-again">play again</button><button id="dont-play-again">back to lobby</button>');
   });   
   
   //for debugging only
   socket.on('fdice', function(data) {
     bggame.board.dice.froll(data);
     bggame.board.update({ forPlayer : me.num });
   });
   
   socket.on('update', function(data) {
     console.log("got update event!!");
     var i;
     var tempMove;
     var moves = data.moves;
     var aMoves = [];
	 
     for (i = 0; i < moves.length; i++) {
       var tempMove = new AMove(moves[i].turnNo, moves[i].player, moves[i].fromNo, moves[i].fromType, moves[i].toNo, moves[i].toType, moves[i].isToHit, moves[i].diceValue);
	   aMoves.push(tempMove);
     }
	 bggame.board.move(aMoves);
	 bggame.board.waitingForNextTurn = false;
   });
   
   socket.on( 'double request', function( data ) {
     if (data.requestingPlayer == me.num) {
       $('#doubling-area').html("waiting for user to decide on double...");
     } else if ((((data.requestingPlayer % 2) + 1)) == me.num) {
       $('#doubling-area').html('double requested...<button id="double-accept">accecpt double</button><button id="double-reject">resign</button>');
     }
   });
   
   socket.on( 'double action', function( data ) {
     if (data.action == "accept") {
       bggame.board.doublingDice.doubleDice((data.choosingPlayer % 2) + 1);
       $('#doubling-area').html('');
       bggame.board.update({ forPlayer : me.num, drawDoublingDice : true} );
     } else if (data.action == "reject") {
	   console.log( "double rejected" );
	   $('#doubling-area').html('');
       socket.emit('game end', { room: selectedRoom, winnerNum: me.num % 2 + 1, points: bggame.board.doublingDice.value });
     }
   });   
   
   socket.on('update turns', function(data) {
     console.log("got update turns event");
	   var time = 750 * data.numMoves;
	   setTimeout( function() {
	    console.log(time);
        bggame.board.updateTurn();  
        bggame.board.update({ forPlayer: me.num });
	   }, time);
   });
   
   socket.on('leave room', function() {
     console.log("got leave room event");
     resetClient();
     socket.emit('join lobby');
   });
   
   socket.on('my id', function(data) {
     if (bggame.players[0].id == data.myid) {
       me.id = data.myid;
       me.num = 1;
     } else if (bggame.players[1].id == data.myid) {
       me.id = data.myid;
       me.num = 2;	 
     } else {
       console.log("my id -- error finding player id by socket: ", data.myid);
     }
     console.log("my id", me.id, "- player number:", me.num);
     $("#iam-player").html(me.num);
   });
  
   $("#list_of_rooms").on("click", "div[id^='room-leave-']", function(e) {
     selectedRoom = -1;
     socket.emit('leave room');
   }); 
   
   $("#list_of_rooms").on("click", "div[id^='room-join-']", function(e) {
     selectedRoom = $(this).parent().attr('id').split('-')[1];
     socket.emit('join room', {room: selectedRoom});
   });  

   $("div").on("click", "button[id$='play-again']", function(e) {
     var act = this.id.split('-')[0];
	 if ( act == "do" ) {
	   socket.emit('join room', {room: selectedRoom});
	   $('#game-over-area').html('waiting for other player to want to play with you...');
	 } else {
	   socket.emit('exit game', {room: selectedRoom});
	 }
   });      
   
   $("div").on("click", "button[id='undo']", function(e) {
      bggame.board.undoMove();
      bggame.board.update({forPlayer : me.num});
   });   
   
   $("div").on("click", "button[id^='double-']", function(e) {
     var act = this.id.split('-')[1]; // action is either 'accept' or 'reject'
     socket.emit( 'double chosen', { room: selectedRoom, choosingPlayer: me.num, action: act } );
   });

   // for debugging only
   $("div").on("click", "button[id='force-sub']", function(e) {
      var inp = $("#f-inp").val();
      if (inp != "00") {
        socket.emit('force dice', { room: selectedRoom, str: inp });
         $("#f-inp").val("00");
      }
   }); 
   
   $("#create_button").click(function() {
    roomID = Math.floor(Math.random()*999999999);
    socket.emit('new room', { room: roomID });
  });

  function resetClient() {
     $('#game_area').html('');
     $('#lobby').show();
     selectedRoom = -1;
     me = {};
  }
  
</script>
