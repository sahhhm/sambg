<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>bg</title>
  <!--<link rel="stylesheet" type="text/css" href="css/style.css" />-->
</head>
<body>
  <div id="lobby">
    <button id="create_button"> create room </button>
    <div id="list_of_rooms"></div>
  </div>
  
  <div id="game_area"></div>
  
</body>
</html>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="game.js"></script>
<script src="dice.js"></script>
<script src="drawer.js"></script>
<script src="player.js"></script>
<script src="triangle.js"></script>
<script src="bar.js"></script>
<script src="checker.js"></script>
<script src="board.js"></script>
<script src="bg.js"></script>
<script src="turnhistory.js"></script>
<script src="bearoff.js"></script>


<script language="javascript" type="text/javascript">
  var socket = io.connect("http://localhost");
  var selectedRoom = -1;
  var me = {};  
  var bbgame = null; //global game
   
   socket.on('room refresh', function(data){
     var list = $("#list_of_rooms").html('').append('<ul></ul>').find('ul');
     for (var i =0; i < data.length; i++) {
       list.append('<li id="room-' + data[i] +'"><div id="room">' + data[i] + '</div></li>');
     }
     
     if (selectedRoom != -1) {
       $('#create_button').attr('disabled', true);
       $("#room-"+selectedRoom).append('<div id="room-leave-'+selectedRoom+'"> - leave</div>'); 
     } else {
       $('#create_button').attr('disabled', false);
       $("#list_of_rooms li").each(function(index) {
         $(this).append('<div id="room-join-'+selectedRoom+'"> - join</div>');
       });
     }

   });
   
   socket.on('room chosen', function(data){
     selectedRoom = data.room;
   });
   
   socket.on('load game', function(data){
     $('#lobby').hide();
     initGame(null, data);
     newGame();
   });
   
   socket.on('dice', function(data) {
     console.log("got dice event");
        bggame.setRoll(data.die1, data.die2);
   });
   
   //for debugging only
   socket.on('fdice', function(data) {
     bggame.board.dice.froll(data);
     bggame.board.update({draw:true,confirm:true,text:true,undo:false});
   });
   
   socket.on('update', function(data) {
     console.log("got update event!!");
     var i;
     var tempMove;
     var moves = data.moves;
     
     for (i = 0; i < moves.length; i++) {
       var tempMove = new AMove(moves[i].turnNo, moves[i].player, moves[i].fromNo, moves[i].fromType, moves[i].toNo, moves[i].isToHit);
       bggame.board.move(tempMove);
       bggame.board.update({draw:true,confirm:true,text:true,undo:false}); // confirm should be false... look into.
     }
   });
   
   socket.on('update turns', function() {
      console.log("got update turns event");
      bggame.board.turns.clearCurrentToHistory();
      bggame.board.update({draw:true,confirm:false,text:true,undo:true});
   });
   
   socket.on('force leave room', function() {
     console.log("got force leave room event");
     resetClient();
     socket.emit('join lobby');
   });
   
   socket.on('my id', function(data) {
     if (bggame.players[0].id == data.myid) {
       me.id = data.myid;
       me.num = 1;
     } else if (bggame.players[1].id == data.myid) {
       me.id = data.myid;
       me.num = 2;	 
     } else {
       console.log("my id -- error finding player id by socket: ", data.myid);
     }
     console.log("my id", me.id, "- player number:", me.num);
     $("#iam-player").html(me.num);
   });
  
   $("div").on("click", "div[id^='room-leave-']", function(e) {
     selectedRoom = -1;
     socket.emit('leave room');
   }); 
   
   $("div").on("click", "div[id^='room-join-']", function(e) {
     selectedRoom = $(this).parent().attr('id').split('-')[1];
     socket.emit('join room', {room: selectedRoom});
   });  

   $("div").on("click", "div[id='c-button']", function(e) {
      socket.emit('moved', { room: selectedRoom, moves:bggame.board.turns.currentTurn});
   });

   $("div").on("click", "div[id='u-button']", function(e) {
      bggame.board.undoMove();
      bggame.board.update({draw:true,confirm:true,text:true,undo:true});
   });    

  
   // for debugging only
   $("div").on("click", "div[id='force-dice']", function(e) {
      var inp = $("#f-inp").val();
      if (inp != "00") {
        socket.emit('force dice', { room: selectedRoom, str: inp });
         $("#f-inp").val("00");
      }
   }); 
   
   $("#create_button").click(function() {
    roomID = Math.floor(Math.random()*999999999);
    socket.emit('new room', { room: roomID });
  });

  function resetClient() {
     $('#game_area').html('');
     $('#lobby').show();
     selectedRoom = -1;
     me = {};
  }
  
</script>